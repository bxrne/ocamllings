name: Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup OCaml
      uses: ocaml/setup-ocaml@v3
      with:
        ocaml-compiler: 5.1.x
        dune-cache: true
        
    - name: Install dependencies
      run: |
        opam install dune
        opam install . --deps-only --with-test
        opam install bisect_ppx
        
    - name: Run tests with coverage
      run: |
        dune runtest --instrument-with bisect_ppx
        bisect-ppx-report html
        bisect-ppx-report summary
        
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: _coverage/
        
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const summary = fs.readFileSync('_coverage/summary.txt', 'utf8');
            const coverageMatch = summary.match(/Coverage: (\d+\.\d+)%/);
            if (coverageMatch) {
              const coverage = coverageMatch[1];
              const comment = `## ðŸ“Š Test Coverage Report\n\n**Current Coverage: ${coverage}%**\n\n[View detailed coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          } catch (error) {
            console.log('Could not read coverage summary:', error);
          }
